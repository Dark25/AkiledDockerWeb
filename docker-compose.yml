version: '3.9'
services:
  web:
    build: ./web
    env_file:
      - .env
    ports:
      - 82:80
    volumes:
      - ./web/configs/nginx.conf.template:/etc/nginx/nginx.conf.template
      - ./web/configs/nginx.mimetypes.conf:/etc/nginx/nginx.mimetypes.conf
      - ./www:/usr/share/nginx/html
      - ./web/include:/usr/share/nginx/include:ro
      - ./logs/nginx:/usr/share/nginx/logs
    command: ["dockerize",
              "-template", "/etc/nginx/nginx.conf.template:/etc/nginx/nginx.conf",
              "-template", "/usr/share/nginx/html/system/brain-config.php.template:/usr/share/nginx/html/system/brain-config.php",
              "-template", "/usr/share/nginx/html/swfs/gamedata/vars.txt.template:/usr/share/nginx/html/swfs/gamedata/vars.txt",
              "-template", "/usr/share/nginx/html/swfs/nitro/ui-config.json.template:/usr/share/nginx/html/swfs/nitro/ui-config.json",
              "-template", "/usr/share/nginx/html/swfs/nitro/renderer-config.json.template:/usr/share/nginx/html/swfs/nitro/renderer-config.json",
              "/usr/local/sbin/runsvdir-init"]
  db:
    image: mariadb:10.4.21
    ports:
      - 3307:3306
    volumes:
      - ./data/MariaDB:/var/lib/mysql
    command: --sql_mode=''
    environment:
      MARIADB_ROOT_PASSWORD: ''
      MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: 1
  redis:
    image: redis:latest
    ports:
      - 6379:6379
    volumes:
      - ./data/Redis:/data
  game:
    build: ./gameEmu
    env_file:
      - .env
    ports:
      - 527:527
      - 30001:30001
      - 30000:30000
    volumes:
      - ./gameEmu/templates/configuration.ini.template:/app/Settings/configuration.ini.template:ro
      - ./logs/game:/app/logs
    command: ["dockerize",
              "-template", "/app/Settings/configuration.ini.template:/app/Settings/configuration.ini",
              "dotnet", "AkiledEmulator.dll"]
  websockify:
    build: ./websockify
    ports:
      - 2096:2096
    command: ["node", "websockify.js", "0.0.0.0:2096", "game:30000"]
#  # -- BEGIN PhpMyAdmin 
#  # If this is uncommented, then you will get a PHPMyAdmin page on localhost:8081
#  phpmyadmin:
#    image: phpmyadmin/phpmyadmin
#    links:
#      - db
#    environment:
#      PMA_HOST: db
#      PMA_PORT: 3306
#      PMA_ARBITRARY: 1
#      UPLOAD_LIMIT: 10G
#    restart: always
#    ports:
#      - 8081:80
#   # -- END PhpMyAdmin
